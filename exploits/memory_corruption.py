#!/usr/bin/env python3
# Memory Corruption Exploits

import ctypes
import mmap
import os

class MemoryCorruption:
    def __init__(self):
        self.libc = ctypes.CDLL(None)
        
    def heap_spray(self, size_mb=100):
        """رش الذاكرة (Heap Spraying)"""
        print(f"[+] Performing heap spray of {size_mb}MB...")
        
        # تخصيص كتل كبيرة من الذاكرة
        for i in range(size_mb):
            try:
                # تخصيص 1MB
                block = mmap.mmap(-1, 1024*1024, 
                                 access=mmap.ACCESS_WRITE)
                
                # ملء بنمط معين
                pattern = b"\\x41" * 1024  # AAA...
                for j in range(1024):
                    block[j*1024:(j+1)*1024] = pattern
                    
            except:
                break
                
        return True
        
    def use_after_free(self):
        """محاكاة ثغرة Use-After-Free"""
        import gc
        
        class VulnerableObject:
            def __init__(self, data):
                self.data = data
                
            def __del__(self):
                # محاكاة الذاكرة المحررة
                print("[+] Object freed, but reference might still exist")
                
        # إنشاء كائن
        obj = VulnerableObject("Sensitive Data")
        
        # حفظ المرجع
        dangling_ref = obj
        
        # حذف الكائن
        del obj
        
        # محاولة الوصول للذاكرة المحررة
        try:
            # هذا سيفشل في Python لكنه يمثل الفكرة
            gc.collect()
            print("[+] Attempting to access freed memory...")
        except:
            pass
            
    def buffer_overflow_simulation(self):
        """محاكاة تجاوز السعة (Buffer Overflow)"""
        buffer = bytearray(100)  # buffer صغير
        
        # محاولة كتابة بيانات أكبر من السعة
        try:
            large_data = b"A" * 200
            buffer[:len(large_data)] = large_data
            print("[+] Buffer overflow simulated")
        except Exception as e:
            print(f"[-] Buffer overflow prevented: {e}")
